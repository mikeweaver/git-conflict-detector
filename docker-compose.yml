version: '2'

services:
  post_deploy_checker_web:
    build:
      context: .
      args:
        RAILS_ENV: production
    image: invocaops/post_deploy_checker
    ports:
       - "3000:3000"
    env_file: docker-secrets.env
    # Must define the following the docker-secrets.env file
    # SECRET_KEY_BASE - Rails secret key
    # SMTP_USER_NAME
    # SMTP_PASSWORD
    # SMTP_ADDRESS
    environment:
      RAILS_ENV: production
    command: ./script/docker_entry_points/unicorn.sh
    volumes:
      - ./tmp/cache/git:/tmp/git
      - ./db/sqlite:/usr/src/pre_deploy_checker/db/sqlite
      - ./log/docker:/usr/src/pre_deploy_checker/log
  post_deploy_checker_delayed_job:
    build:
      context: .
      args:
        RAILS_ENV: production
    image: invocaops/post_deploy_checker
    env_file: docker-secrets.env
    # Must define the following the docker-secrets.env file
    # SECRET_KEY_BASE - Rails secret key
    # GITHUB_USER_NAME
    # GITHUB_PASSWORD
    # GITHUB_PRIVATE_KEY - Private key that can clone the repos you want to process
    # JIRA_PRIVATE_KEY - Private key used to read from JIRA via OAuth
    environment:
      RAILS_ENV: production
    command: ./script/docker_entry_points/delayed_job.sh
    volumes_from:
       - post_deploy_checker_web


