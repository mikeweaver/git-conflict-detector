<%= form_for @push, url: "/jira/status/push/#{@push.head_commit.sha}.html" do |form| %>

<div class="container">
  TODO: Show the tags on the commit, autobahn clean, build clean
  <% if flash[:alert] %>
    <div class="alert alert-success"><%= flash[:alert] %></div>
  <% end %>
  <%case @push.status%>
  <%when Github::Api::Status::STATE_PENDING.to_s%>
    <div class="alert alert-warning">
      Push is being processed, please refresh in a moment
    </div>
  <%when Github::Api::Status::STATE_SUCCESS.to_s%>
    <div class="alert alert-success">
      <%if @push.has_errors? %>
      Push failed some checks, but all of them have been ignored
      <%else%>
      Push passed all checks
      <%end%>
    </div>
  <%when Github::Api::Status::STATE_FAILED.to_s%>
    <div class="alert alert-danger">
      Warning: Branch is not ready to deploy.<br>
      <ul>
      <%get_combined_error_counts.each do |error_object, error_counts|%>
          <%error_counts.each do |error_code, count|%>
            <li><%=count%> <%=map_error_code_to_message(error_object, error_code)%>
        <%end%>
      <%end%>
      </ul>
    </div>
  <%end%>
  <%if @push.has_jira_issues%>
    <h4><%=@push.jira_issues.count%> JIRA issues(s) in this branch</h4>
    <table class="table table-striped">
      <thead>
      <tr>
        <th>Ignore</th>
        <th>Key</th>
        <th>Last SHA</th>
        <th>Assignee</th>
        <th>Status</th>
        <th>Deploy Date</th>
        <th>Summary</th>
      </tr>
      </thead>
      <tbody>
      <%@push.jira_issues_and_pushes.each do |jira_issue_and_push|%>
        <%
          jira_issue = jira_issue_and_push.jira_issue
          row_class = if jira_issue_and_push.has_unignored_errors?
                        'danger'
                      elsif jira_issue_and_push.has_ignored_errors?
                        'warning'
                      end
        %>
        <tr class="<%=row_class%>">
          <td><%= check_box_tag "push[jira_issue_keys_to_ignore][]", jira_issue.key, jira_issue_and_push.has_ignored_errors?, disabled: !jira_issue_and_push.has_errors? %></td>
          <td nowrap>
            <%if jira_issue.parent_issue %>
              <%=link_to(jira_issue.parent_issue.key, jira_url_for_issue(jira_issue.parent_issue), target: '_blank')%><br/>&#8627;
            <%end%>
            <%=link_to(jira_issue.key, jira_url_for_issue(jira_issue), target: '_blank')%>
          </td>
          <td><%=link_to(jira_issue.latest_commit.short_sha, github_url_for_commit(jira_issue.latest_commit), target: '_blank')%></td>
          <td nowrap><%=jira_issue.assignee.name%></td>
          <td nowrap><%=jira_issue.status%></td>
          <td nowrap><%=jira_issue.targeted_deploy_date || '-'%></td>
          <td><%=jira_issue.summary%></td>
        </tr>
      <%end%>
      </tbody>
    </table>
  <%end%>

  <%if @push.has_commits_with_errors? %>
    <h4><%=@push.commits_with_errors.count%> Commit(s) with errors</h4>
    <table class="table table-striped">
      <thead>
      <tr>
        <th>Ignore</th>
        <th>SHA</th>
        <th>Author Name</th>
        <th>Commit Message</th>
      </tr>
      </thead>
      <tbody>
      <%@push.commits_and_pushes.with_errors.each do |commit_and_push|%>
        <%
          commit = commit_and_push.commit
          row_class = if commit_and_push.has_unignored_errors?
                        'danger'
                      elsif commit_and_push.has_ignored_errors?
                        'warning'
                      end
        %>
        <tr class="<%=row_class%>">
          <td><%= check_box_tag "push[commit_shas_to_ignore][]", commit.sha, commit_and_push.has_ignored_errors?, disabled: !commit_and_push.has_errors? %></td>
          <td><%=link_to(commit.short_sha, github_url_for_commit(commit), target: '_blank')%></td>
          <td nowrap><%=commit.author.name%></td>
          <td><%=commit.message%></td>
        </tr>
      <%end%>
      </tbody>
    </table>
  <%end%>
  <%if false%>
    <h4>JIRA issues ready to deploy, but not in this branch</h4>
    <table class="table table-striped">
      <thead>
      <tr>
        <th>Ignore</th>
        <th>Key</th>
        <th>Last SHA</th>
        <th>Assignee</th>
        <th>Status</th>
        <th>Deploy Date</th>
        <th>Summary</th>
      </tr>
      </thead>
      <tbody>
      <tr>
        <td><input type="checkbox" checked></td>
        <td><a href="#">STORY-4533</a></td>
        <td><a href="#">aaf2ef4</a></td>
        <td>Yo Biziiac</td>
        <td>Ready to Deploy</td>
        <td>11/27/2016</td>
        <td>Description for ya</td>
      </tr>
      <tr class="danger">
        <td><input type="checkbox"></td>
        <td><a href="#">STORY-9999</a></td>
        <td><a href="#">bbf2ef4</a></td>
        <td>Dave Lamo</td>
        <td>Ready to Deploy</td>
        <td>11/30/2016</td>
        <td>The thingermahowzer</td>
      </tr>
      </tbody>
    </table>
  <%end%>
  <%= form.submit('Save and Refresh', :name => 'save') %>
  <%= form.submit('Refresh', :name => 'refresh') %>
  Copy/Paste deploy list
</div>
<% end %>
